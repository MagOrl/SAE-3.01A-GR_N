CREATE TABLE
    HABILITATION (IdHab varchar(10) primary key, nomHab varchar(20));

CREATE TABLE
    PERSONNEL (
        IdPers varchar(10) primary key,
        nomPers varchar(20)
    );

CREATE TABLE
    PLATEFORME (
        IdPla varchar(10) primary key,
        nomPla varchar(20),
        nbPersNec int,
        coutExploiJ decimal(10, 2),
        interMainte int
    );

CREATE TABLE
    MATERIEL (
        IdMat varchar(10) primary key,
        IdHab varchar(10),
        nomMat varchar(20),
        foreign key (IdHab) references HABILITATION (IdHab)
    );


CREATE TABLE
    UTILISER (
        IdMat varchar(10),
        IdPla varchar(10),
        primary key (IdMat, IdPla),
        foreign key (IdMat) references MATERIEL (IdMat),
        foreign key (IdPla) references PLATEFORME (IdPla)
    );

CREATE TABLE
    NECESSITER (
        IdHab varchar(10),
        IdPla varchar(10),
        primary key (IdHab, IdPla),
        foreign key (IdHab) references HABILITATION (IdHab),
        foreign key (IdPla) references PLATEFORME (IdPla)
    );

CREATE TABLE
    SPECIALISER_EN (
        IdHab varchar(10),
        IdPers varchar(10),
        primary key (IdHab, IdPers),
        foreign key (IdHab) references HABILITATION (IdHab),
        foreign key (IdPers) references PERSONNEL (IdPers)
    );


create TABLE
    CAMPAGNE (
        IdCamp varchar(10),
        IdPla varchar(10),
        nomLieuFouille varchar(20),
        duree float,
        jma date,
        primary key (IdCamp),
        foreign key (IdPla) references PLATEFORME (IdPla)
    );

CREATE TABLE
    PARTICIPER (
        IdPers varchar(10),
        IdCamp varchar(10),
        primary key (IdPers, IdCamp),
        foreign key (IdPers) references PERSONNEL (IdPers),
        foreign key (IdCamp) references CAMPAGNE (IdCamp)
    );

CREATE TABLE
    SEQUENCE (IdSeq varchar(10) primary key);

CREATE TABLE
    EXTRAIRE (
        IdSeq varchar(10),
        IdCamp varchar(10),
        primary key (IdCamp, IdSeq),
        foreign key (IdCamp) references CAMPAGNE (IdCamp),
        foreign key (IdSeq) references SEQUENCE (IdSeq)
    );

CREATE TABLE
    ESPECE (
        IdEsp varchar(10) primary key,
        IdSeq varchar(10),
        NomEsp varchar(40),
        foreign key (IdSeq) references SEQUENCE (IdSeq)
    );

CREATE TABLE
    ECHANTILLION (
        IdEch varchar(10) primary key,
        IdSeq varchar(10),
        commentaire varchar(255),
        foreign key (IdSeq) references SEQUENCE (IdSeq)
    );

delimiter |
CREATE OR REPLACE TRIGGER bonneAbilite 
BEFORE INSERT ON PARTICIPER FOR EACH ROW 
begin 
    IF ((select IdHab from PERSONNEL natural join SPECIALISER_EN where IdPers = NEW.IdPers) != (select IdHab from CAMPAGNE natural join PLATEFORME natural join NECESSITER where IdCamp = NEW.IdCamp))
    THEN 
        signal SQLSTATE '45000' set MESSAGE_TEXT = 'Pas la bonne habilité pour le personel.';
    END IF;
end |
delimiter ;

-- TODO La deuxième est assez difficile je vais la faire après
-- delimiter |
-- CREATE OR REPLACE TRIGGER verifDureePlateform 
-- BEFORE INSERT ON CAMPAGNE FOR EACH ROW 
-- begin 
-- declare maintenance varchar(255);
--     IF( )
--     THEN 
--         signal SQLSTATE '45000' set MESSAGE_TEXT = 'Pas la bonne habilité pour le personel.';
--     END IF;
-- end |
-- delimiter ;

delimiter |
CREATE OR REPLACE TRIGGER verifPersonnelAffecte 
BEFORE INSERT ON PARTICIPER FOR EACH ROW 
begin 
    declare dateCamp date;
    declare dureeCamp float;
    declare dateAjoute date;
    declare dateFinCamp date;
    declare fini boolean DEFAULT FALSE;
    
    declare cursPersonnel CURSOR FOR 
        SELECT c.jma, c.duree 
        FROM CAMPAGNE c 
        NATURAL JOIN PARTICIPER p 
        WHERE p.IdPers = NEW.IdPers;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET fini = TRUE;

    SELECT jma INTO dateAjoute FROM CAMPAGNE WHERE IdCamp = NEW.IdCamp;

    OPEN cursPersonnel; 
    
    read_loop: LOOP
        FETCH cursPersonnel INTO dateCamp, dureeCamp;
        
        IF fini THEN
            LEAVE read_loop;
        END IF;        
        
        SET dateFinCamp = DATE_ADD(dateCamp, INTERVAL dureeCamp DAY);        
        
        IF (dateAjoute >= dateCamp AND dateAjoute <= dateFinCamp) THEN 
            signal SQLSTATE '45000' set MESSAGE_TEXT = 'Le personnel est déjà affecté à une autre campagne pendant cette période.';
        END IF; 
        
    END LOOP;
    
    CLOSE cursPersonnel;
end |
delimiter ;

delimiter |
CREATE OR REPLACE TRIGGER verifPlateformeAffecte 
BEFORE INSERT ON CAMPAGNE FOR EACH ROW 
begin 
    declare dateCamp date;
    declare dureeCamp float;
    declare dateFinCamp date;
    declare nouvDateFin date;
    declare fini boolean DEFAULT FALSE;
    
    declare cursPlatforme CURSOR FOR 
        SELECT c.jma, c.duree 
        FROM CAMPAGNE c 
        WHERE c.IdPla = NEW.IdPla;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET fini = TRUE;


    OPEN cursPlatforme; 
    
    read_loop: LOOP
        FETCH cursPlatforme INTO dateCamp, dureeCamp;
        
        IF fini THEN
            LEAVE read_loop;
        END IF;        

        SET dateFinCamp = DATE_ADD(dateCamp, INTERVAL dureeCamp DAY);        
        SET nouvDateFin =  DATE_ADD(NEW.jma, INTERVAL NEW.duree DAY); 

        IF (NEW.jma >= dateCamp AND NEW.jma <= dateFinCamp) OR (nouvDateFin >= dateCamp AND nouvDateFin <= dateFinCamp) THEN 
            signal SQLSTATE '45000' set MESSAGE_TEXT = 'La plateforme est déjà affecté à une autre campagne pendant cette période.';
        END IF; 
        
    END LOOP;
    
    CLOSE cursPlatforme;
end |
delimiter ;